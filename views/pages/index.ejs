<!DOCTYPE html>
<html lang="fr">
  <head>
    <%- include('../partials/head'); %>
    <link rel="stylesheet" href="/style.css" />
  </head>

  <body class="container">
    <main>
      <h1 class="titre">Le jeu du pendu &#128520;</h1>
      <p>Essayez de deviner le mot !</p>

      <div class="score-timer-container">
        <h2>Score : <span id="score"><%= score %></span></h2>
        <h2>
          Temps Ã©coulÃ© : <span id="timer"><%= elapsedTime %></span> secondes
        </h2>
      </div>

      <!-- On vÃ©rifie si le jeu est terminÃ© avant d'afficher le formulaire -->
      <% if (numberOfTries > 0 && game.indexOf('#') !== -1) { %>
      <form id="guessForm" action="/" method="post">
        <fieldset class="fieldset-style">
          <legend class="legend-style">
            Nombre d'essais restants : <%= numberOfTries %>
          </legend>

          <div class="input-container">
            <input
              class="input-style"
              type="text"
              name="word"
              id="wordInput"
              placeholder="Tapez une lettre"
              maxlength="1"
              required
            />
          </div>

          <div class="button-container">
            <button
              class="button-style button-test"
              type="submit"
              value="form-success"
            >
              Tester
            </button>
          </div>
        </fieldset>
      </form>
      <% } %> <% if (game) { %>
      <h3 class="word-display">Mot Ã  deviner : <%= game %></h3>
      <% } %> <% if (game && game.indexOf('#') === -1) { %>
      <div class="end-game victory">
        ðŸŽ‰ Vous avez gagnÃ© !
        <h4>Score final : <%= score %></h4>
      </div>
      <% } else if (numberOfTries <= 0) { %>
      <div class="end-game defeat">
        ðŸ˜ž Vous avez perdu...
        <h3 class="classh3">Le mot Ã©tait : <%= word %></h3>
        <h4>Score final : <%= score %></h4>
      </div>
      <% } %>

      <!-- Boutons de partage -->
      <% if (game && game.indexOf('#') === -1 || numberOfTries <= 0) { %>
      <div class="share-container">
        <button id="emailButton" class="button-style email-button">
          Partager par E-mail
        </button>
      </div>
      <% } %>
    </main>

    <% if (typeof error !== 'undefined' && error) { %>
    <script>
      alert("<%= error %>");
    </script>
    <% } %>

    <script>
      let initialElapsedTime = <%= elapsedTime %>;
      let initialScore = <%= score %>;
      let startTime = Date.now() - initialElapsedTime * 1000;
      let gameEnded = <%= (numberOfTries <= 0 || (game && game.indexOf('#') === -1)) %>;

      function updateTimerAndScore() {
        if (gameEnded) return;

        const currentTime = Date.now();
        const elapsedTime = Math.floor((currentTime - startTime) / 1000);
        const newScore = initialScore - elapsedTime;

        document.getElementById("timer").innerText = elapsedTime;
        document.getElementById("score").innerText = newScore;
      }

      const intervalId = setInterval(() => {
        updateTimerAndScore();

        // ArrÃªter le timer si le jeu est terminÃ©
        if (gameEnded) {
          clearInterval(intervalId);
        }
      }, 1000);

      if (gameEnded) {
        clearInterval(intervalId);
      }

      // Fonction de partage par E-mail
      document.getElementById('emailButton').onclick = function() {
        const score = <%= score %>;
        const subject = "Mon score au jeu du pendu";
        const body = `Je viens de terminer le jeu du pendu avec un score de ${score} points ! Pouvez-vous battre mon score ? Rendez-vous sur http://localhost:3030/`;

        const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;

        window.location.href = mailtoLink;
        return false;
      };
    </script>
  </body>
</html>
