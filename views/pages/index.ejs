<!DOCTYPE html>
<html lang="fr">
  <head>
    <%- include('../partials/head'); %>
    <link rel="stylesheet" href="/style.css" />
  </head>

  <body class="container">
    <main>
      <h1 class="titre">Le jeu du pendu &#128520;</h1>
      <p>Essayez de deviner le mot !</p>

      <div class="score-timer-container">
        <h2>Score : <span id="score"><%= score %></span></h2>
        <h2>
          Temps Ã©coulÃ© : <span id="timer"><%= elapsedTime %></span> secondes
        </h2>
      </div>

      <% if (numberOfTries > 0 && game.indexOf('#') !== -1) { %>
      <form id="guessForm" action="/" method="post">
        <fieldset class="fieldset-style">
          <legend class="legend-style">
            Nombre d'essais restants : <%= numberOfTries %>
          </legend>
          <div class="input-container">
            <input
              class="input-style"
              type="text"
              name="word"
              id="wordInput"
              placeholder="Tapez une lettre"
              maxlength="1"
              required
            />
          </div>
          <div class="button-container">
            <button
              class="button-style button-test"
              type="submit"
              value="form-success"
            >
              Tester
            </button>
          </div>
        </fieldset>
      </form>
      <% } %> <% if (game) { %>
      <h3 class="word-display">Mot Ã  deviner : <%= game %></h3>
      <% } %>

      <!-- Popup pour entrer le nom -->
      <div id="winnerPopup" class="popup" style="display: none">
        <div class="popup-content">
          <h3>FÃ©licitations ! ðŸŽ‰</h3>
          <p>Entrez votre nom pour enregistrer votre score :</p>
          <form id="winnerForm">
            <input
              type="text"
              id="winnerName"
              name="winnerName"
              placeholder="Votre nom"
              required
            />
            <div style="margin-bottom: 10px">
              <button id="submitNameButton" type="submit" class="button-style">
                Enregistrer
              </button>
            </div>
            <button id="closePopupButton" class="button-style close-button">
              Fermer la popup
            </button>
          </form>
        </div>
      </div>

      <% if (numberOfTries <= 0) { %>
      <div class="end-game defeat">
        ðŸ˜ž Vous avez perdu...
        <h3 class="classh3">Le mot Ã©tait : <%= word %></h3>
        <h4>Score final : <%= score %></h4>
      </div>
      <% } %>

      <section>
        <p>Tableau des scores</p>
        <table id="scoreTable" border="1" class="container">
          <thead>
            <tr>
              <th>Nom</th>
              <th>Score</th>
            </tr>
          </thead>
          <tbody>
            <% if (scores.length > 0) { %> <% scores.forEach((score) => { %>
            <tr>
              <td><%= score.name %></td>
              <td><%= score.score %></td>
            </tr>
            <% }); %> <% } else { %>
            <tr>
              <td colspan="2">Aucun gagnant pour le moment</td>
            </tr>
            <% } %>
          </tbody>
        </table>
      </section>
    </main>

    <script>
            let score = <%= score %>;
            let elapsedTime = <%= elapsedTime %>;
            let startTime = Date.now() - elapsedTime * 1000;
            let gameEnded = <%= (numberOfTries <= 0 || (game && game.indexOf('#') === -1)) %>;

            function updateTimerAndScore() {
              if (gameEnded) return; // Stop updates if the game has ended

              const now = Date.now();
              const newElapsedTime = Math.floor((now - startTime) / 1000);
              const newScore = Math.max(score - newElapsedTime, 0); // Le score ne peut pas Ãªtre nÃ©gatif

              // Mise Ã  jour dans le DOM
              document.getElementById("timer").innerText = newElapsedTime;
              document.getElementById("score").innerText = newScore;
            }

            // Mettre Ã  jour le timer et le score toutes les secondes
            const intervalId = setInterval(() => {
              updateTimerAndScore();

              // Si le jeu est terminÃ©, arrÃªter l'intervalle et afficher la popup
              if (gameEnded) {
                clearInterval(intervalId);
                if (document.getElementById("winnerPopup")) {
                  document.getElementById("winnerPopup").style.display = "block";
                }
              }
            }, 1000);

            // GÃ©rer le formulaire de soumission du nom
            const winnerForm = document.getElementById("winnerForm");
            if (winnerForm) {
              winnerForm.onsubmit = (e) => {
                e.preventDefault();

                const name = document.getElementById("winnerName").value;
                document.getElementById("submitNameButton").disabled = true;

                fetch("/save-score", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ name, score }),
                })
                  .then(() => {
                    alert("Score enregistrÃ© avec succÃ¨s !");
                    location.reload(); // Recharger la page pour mettre Ã  jour le tableau des scores
                  })
                  .catch((err) => console.error("Erreur:", err));
              };
              document.getElementById('closePopupButton').onclick = () => {
          document.getElementById('winnerPopup').style.display = 'none';
      };

            }
    </script>
  </body>
</html>
